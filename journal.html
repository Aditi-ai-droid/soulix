<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soul Notes — Dreamy Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Pacifico&display=swap" rel="stylesheet">
  <style>
    /* ===========================
       Dreamy Pastel Theme (full)
       Pink-Lavender-Mint + strong glow
       =========================== */

    :root{
      --bg-1: #fff6fb;
      --bg-2: #f5fbff;
      --card: rgba(255,255,255,0.85);
      --glass: rgba(255,255,255,0.18);
      --accent-pink: #f9c8d1;
      --accent-lav: #e2d3f7;
      --accent-mint: #d7f3ec;
      --accent-peach: #fbe5c8;
      --text: #3d2b3b;
      --muted: #8b7586;
      --shadow-strong: 0 18px 60px rgba(80,40,100,0.12);
      --shadow-soft: 0 6px 22px rgba(80,40,100,0.08);
      --glass-border: rgba(255,255,255,0.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(242,210,235,0.35), transparent 10%),
                  radial-gradient(1000px 500px at 90% 90%, rgba(212,232,255,0.28), transparent 12%),
                  linear-gradient(180deg, var(--bg-1), var(--bg-2));
      overflow-y:auto;
    }

    /* floating particle canvas sits behind everything */
    #particle-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:screen;opacity:0.85}

    header{
      position:sticky;
      top:0;
      z-index:50;
      display:flex;
      align-items:center;
      gap:18px;
      padding:18px 32px;
      background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.12));
      backdrop-filter: blur(8px) saturate(1.1);
      border-bottom: 1px solid rgba(255,255,255,0.25);
      box-shadow: var(--shadow-soft);
      margin-bottom:8px;
    }

    .logo{display:flex;align-items:center;gap:14px;z-index:51}
    .logo .mark{
      width:54px;height:54px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-lav));
      display:flex;align-items:center;justify-content:center;
      font-family:Pacifico;color:rgba(61,43,59,0.95);font-weight:700;font-size:20px;
      box-shadow: 0 8px 30px rgba(158,88,123,0.12), inset 0 -6px 24px rgba(255,255,255,0.25);
    }
    .title{font-weight:700;font-size:18px;color:var(--text)}
    .subtitle{font-size:12px;color:var(--muted)}

    /* header right actions */
    .header-actions{margin-left:auto;display:flex;gap:12px;align-items:center;z-index:51}
    .search {
      padding:10px 14px;border-radius:12px;border:none;background:rgba(255,255,255,0.9);
      width:260px;box-shadow:0 6px 20px rgba(100,60,110,0.05);
      outline:none;
    }
    .btn {
      padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent-pink),var(--accent-lav));
      color:var(--text);font-weight:700;cursor:pointer;box-shadow:var(--shadow-soft);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-3px);box-shadow:var(--shadow-strong)}

    /* hero */
    .top-hero{display:flex;gap:22px;padding:28px 32px;align-items:center;z-index:20;position:relative}
    h1{font-family:Pacifico,cursive;font-size:48px;margin:0;color:#a56a95;line-height:1}
    p.lead{margin:0;background:linear-gradient(90deg, rgba(249,200,209,0.18), rgba(226,211,247,0.12));
      padding:12px 16px;border-radius:12px;color:var(--muted);max-width:820px;backdrop-filter: blur(4px);}

    .container{display:grid;grid-template-columns:1fr 360px;gap:28px;padding:6px 32px 60px;align-items:start;position:relative;z-index:10}
    .left{min-width:0}
    .right{position:relative}

    /* nav tabs */
    .nav-tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{
      background:transparent;border-radius:12px;padding:10px 14px;border:1px solid transparent;font-weight:700;cursor:pointer;
      transition:all .18s ease;color:rgba(61,43,59,0.9)
    }
    .tab-btn.active{
      background: linear-gradient(135deg,var(--accent-pink),var(--accent-lav));
      box-shadow: 0 12px 36px rgba(158,88,123,0.12);
      color: #3b2633;
      transform:translateY(-3px)
    }

    /* panels */
    .panel{
      margin-top:18px;background:var(--card);border-radius:18px;padding:20px;border:1px solid var(--glass-border);
      box-shadow: var(--shadow-strong);
      backdrop-filter: blur(6px) saturate(1.05);
    }

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

    /* small text */
    .small-muted{font-size:13px;color:var(--muted)}

    /* dashboard */
    #recentEntry{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));border:1px solid rgba(255,255,255,0.6)}

    /* mood pills */
    .mood-row{display:flex;gap:12px;align-items:center}
    .mood-pill{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.6);cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));text-align:center;min-width:72px}
    .mood-pill.selected{box-shadow:0 10px 30px rgba(150,70,120,0.12);transform:translateY(-4px)}

    /* journal */
    .journal-area{width:100%;min-height:260px;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.6);background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));box-shadow:0 10px 30px rgba(100,60,110,0.04)}

    /* gratitude / lists */
    .list{list-style:none;padding:0;margin:0}
    .list li{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.7);margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.95), #fff);}
    .list li.done{opacity:0.6;text-decoration:line-through}

    /* HABIT TRACKER (exact screenshot-style cards) */
    .habit-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));gap:16px;margin-top:12px}
    .habit-card{
      border-radius:18px;padding:16px;min-height:140px;color:var(--text);display:flex;flex-direction:column;justify-content:space-between;
      transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s ease;
      border:1px solid rgba(255,255,255,0.5);
      background:linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.7));
      box-shadow: 0 12px 38px rgba(120,60,120,0.08);
    }
    .habit-card:hover{transform:translateY(-8px);box-shadow: 0 26px 80px rgba(120,60,120,0.12)}
    .habit-top{display:flex;justify-content:space-between;align-items:center}
    .habit-title{font-weight:800;font-size:16px}
    .habit-meta{font-size:12px;color:var(--muted)}
    .habit-metric{font-size:22px;font-weight:800;margin-top:6px;color:#44273a}

    /* per-card pastel color accents (match screenshot) */
    .habit-card.p1{background:linear-gradient(135deg,#fce2ea,#ffdbe8);}
    .habit-card.p2{background:linear-gradient(135deg,#eee7ff,#f2ecff);}
    .habit-card.p3{background:linear-gradient(135deg,#e6fdf4,#e8fbf6);}
    .habit-card.p4{background:linear-gradient(135deg,#fff3e4,#fff7ee);}

    .habit-actions{display:flex;gap:10px;align-items:center}
    .tiny-btn{padding:8px 10px;border-radius:12px;border:none;background:rgba(255,255,255,0.8);cursor:pointer;box-shadow:0 6px 18px rgba(100,60,110,0.04)}

    /* TASK MANAGER (sheet-style) */
    .task-overview{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .stat-box{background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.92));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.6);box-shadow:var(--shadow-soft)}

    .task-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    .task-table th{background:linear-gradient(180deg,#fff9fe,#f7f1fb);font-weight:700;color:#5a3553;padding:12px;border-bottom:2px solid rgba(200,180,200,0.18)}
    .task-table td{padding:10px;border-bottom:1px solid rgba(240,225,240,0.7);background:transparent}
    .task-row{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94));border-radius:10px}
    .priority-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700}
    .priority-low{background:rgba(215,243,236,0.8);color:#2a6b5a}
    .priority-med{background:rgba(226,211,247,0.85);color:#4a3270}
    .priority-high{background:rgba(249,200,209,0.9);color:#7a2e43}

    .progress-bar{height:12px;border-radius:12px;background:rgba(250,244,252,0.8);overflow:hidden;border:1px solid rgba(255,255,255,0.6)}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-pink),var(--accent-lav));transition:width .4s ease;box-shadow:inset 0 -4px 12px rgba(0,0,0,0.04)}

    /* goals */
    .goals-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
    .goal-card{padding:12px;border-radius:14px;background:linear-gradient(180deg,#fff,#fbf8ff);border:1px solid rgba(245,235,250,0.6);box-shadow:var(--shadow-soft);display:flex;align-items:center;gap:12px}
    .goal-circle{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#f1e8ff,#fde6ef);font-weight:800;color:#4a2f4f}

    /* right sidebar */
    .mini{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.86));border:1px solid rgba(255,255,255,0.6);box-shadow:var(--shadow-soft)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(40,10,40,0.25), rgba(40,10,40,0.12));z-index:200}
    .modal-card{width:380px;background:linear-gradient(180deg,#ffffff,#fffbff);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.6);box-shadow:0 24px 80px rgba(80,40,100,0.12)}

    /* small helpers */
    input,textarea,select{border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.6);background:linear-gradient(180deg,#fff,#f8f5fb);outline:none}
    .add-row{display:flex;gap:10px;margin-top:12px}
    footer{padding:28px;text-align:center;color:var(--muted);margin-top:30px}

    /* responsive */
    @media(max-width:1100px){.container{grid-template-columns:1fr 320px}.habit-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.container{grid-template-columns:1fr}.habit-grid{grid-template-columns:1fr}.top-hero{flex-direction:column;align-items:flex-start}h1{font-size:34px}}
  </style>
</head>
<body>
  <!-- canvas particles -->
  <canvas id="particle-canvas"></canvas>

  <header>
    <div class="logo">
      <div class="mark">SN</div>
      <div>
        <div class="title">Soul Notes</div>
        <div class="subtitle">Dreamy personal journal</div>
      </div>
    </div>

    <div class="header-actions">
      <input id="globalSearch" class="search" placeholder="Search notes, moods and tasks..." />
      <button id="authButton" class="btn">Log in</button>
    </div>
  </header>

  <div class="top-hero">
    <div>
      <h1>Soul Notes</h1>
      <p class="lead">A cozy, dreamy space for your moods, habits and goals. Sign in to sync across devices.</p>
    </div>
    <div style="margin-left:auto;max-width:360px;width:38%">
      <div style="border-radius:14px;padding:18px;background:linear-gradient(135deg, rgba(249,200,209,0.18), rgba(226,211,247,0.12));box-shadow:0 22px 60px rgba(120,60,120,0.06);min-height:140px;display:grid;place-items:center">
        <div style="font-weight:700;color:#7a4b66">Your aesthetic preview</div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="left">
      <div class="nav-tabs">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="mood">Mood</button>
        <button class="tab-btn" data-tab="journal">Journal</button>
        <button class="tab-btn" data-tab="gratitude">Gratitude</button>
        <button class="tab-btn" data-tab="habits">Habits</button>
        <button class="tab-btn" data-tab="todo">To-Do</button>
        <button class="tab-btn" data-tab="goals">Goals</button>
      </div>

      <!-- Dashboard -->
      <section id="dashboard" class="panel">
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <h3 style="margin:0 0 6px 0">Today's snapshot</h3>
            <div class="small-muted">Mood, top task and a recent note</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
              <div class="mini stat-box">
                <div class="small-muted">Mood</div>
                <div id="dashMood" style="font-weight:800;margin-top:6px">—</div>
              </div>
              <div class="mini stat-box">
                <div class="small-muted">Top Task</div>
                <div id="dashTask" style="font-weight:800;margin-top:6px">—</div>
              </div>
            </div>
          </div>

          <div style="min-width:220px">
            <div class="mini">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-size:20px;font-weight:800" id="dashClock">11:34</div>
                  <div class="small-muted" id="dateNow">—</div>
                </div>
                <div style="text-align:right">
                  <div class="small-muted">Progress</div>
                  <div id="dashProgress" style="font-weight:800">0%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Recent entry</h3>
          <div id="recentEntry" style="min-height:86px;border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));border:1px solid rgba(255,255,255,0.6)">No entries yet — write something in Daily Journal.</div>
        </div>
      </section>

      <!-- Mood -->
      <section id="mood" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">Mood Tracker</h3>
        <div class="mood-row" id="moodRow"></div>

        <div style="margin-top:12px">
          <label class="small-muted">Add a short note</label>
          <textarea id="moodNote" rows="3" style="width:100%;margin-top:8px;border-radius:12px;padding:10px"></textarea>
          <div style="display:flex;align-items:center;gap:10px;margin-top:10px">
            <button id="saveMood" class="btn">Save Mood</button>
            <div id="moodSaved" class="small-muted"></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Past moods</h4>
          <div id="moodHistory"></div>
        </div>
      </section>

      <!-- Journal -->
      <section id="journal" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">Daily Journal</h3>
        <textarea id="journalText" class="journal-area" placeholder="Write your thoughts... (autosaves)"></textarea>
        <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
          <button id="saveJournal" class="btn">Save</button>
          <button id="clearJournal" style="padding:10px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.6);cursor:pointer">Clear</button>
          <input id="imgUpload" type="file" accept="image/*" style="display:none" />
          <button id="attachImg" style="padding:10px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.6);cursor:pointer">Attach Image</button>
        </div>
        <div id="attachedPreview" style="margin-top:12px"></div>
      </section>

      <!-- Gratitude -->
      <section id="gratitude" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">Gratitude</h3>
        <ul id="gratList" class="list"></ul>
        <div class="add-row">
          <input id="gratInput" type="text" placeholder="I'm grateful for..." style="flex:1" />
          <button id="addGrat" class="btn">Add</button>
        </div>
      </section>

      <!-- Habits -->
      <section id="habits" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">Habit Tracker</h3>
        <div class="habit-grid" id="habitGrid"></div>

        <div class="add-row" style="margin-top:14px">
          <input id="habitInput" type="text" placeholder="New habit e.g. Drink water" style="flex:1" />
          <button id="addHabit" class="btn">Add</button>
        </div>
      </section>

      <!-- To-Do / Task Manager -->
      <section id="todo" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">To-Do — Task Manager</h3>

        <div class="task-overview">
          <div class="stat-box">
            <div class="small-muted">Total Tasks</div>
            <div id="totalTasks" style="font-weight:800;font-size:20px">0</div>
          </div>
          <div class="stat-box">
            <div class="small-muted">In Progress</div>
            <div id="inProgressCount" style="font-weight:800;font-size:20px">0</div>
          </div>
        </div>

        <div style="overflow:auto;margin-top:12px">
          <table class="task-table" id="taskTable">
            <thead>
              <tr>
                <th style="width:36px">#</th>
                <th style="min-width:220px">Task</th>
                <th style="width:130px">Priority</th>
                <th style="width:130px">Start</th>
                <th style="width:130px">Due</th>
                <th style="min-width:180px">Notes</th>
                <th style="width:90px">% Complete</th>
                <th style="width:170px">Progress</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody id="taskBody"></tbody>
          </table>
        </div>

        <div class="add-row">
          <input id="todoInput" type="text" placeholder="New task..." style="flex:1" />
          <select id="todoPriority" style="width:140px">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
          </select>
          <button id="addTodo" class="btn">Add Task</button>
        </div>
      </section>

      <!-- Goals -->
      <section id="goals" class="panel" style="display:none">
        <h3 style="margin:0 0 8px 0">Goals</h3>
        <div class="goals-wrap" id="goalsWrap"></div>

        <div class="add-row">
          <input id="goalInput" type="text" placeholder="Add a goal" style="flex:1" />
          <input id="goalTargetDate" type="date" />
          <button id="addGoal" class="btn">Add Goal</button>
        </div>
      </section>
    </div>

    <!-- RIGHT column -->
    <aside class="right">
      <div class="mini" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800;font-size:20px" id="timeNow">11:34</div>
            <div class="small-muted" id="dateNowSub">—</div>
          </div>
          <div style="text-align:right">
            <div class="small-muted">Mood</div>
            <div id="sideMood" style="font-weight:800">—</div>
          </div>
        </div>
      </div>

      <div class="mini" style="margin-bottom:12px">
        <div class="small-muted">Quick Images</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div class="img-placeholder" id="miniImg1" style="border-radius:10px;background:linear-gradient(135deg,#fff3f7,#fff7fb);min-height:80px;display:grid;place-items:center">Img</div>
          <div class="img-placeholder" id="miniImg2" style="border-radius:10px;background:linear-gradient(135deg,#f2f6ff,#faf6ff);min-height:80px;display:grid;place-items:center">Img</div>
        </div>
        <div style="text-align:right;margin-top:8px"><button id="openJournalFromMini" class="btn">Open Journal</button></div>
      </div>

      <div class="mini" style="margin-bottom:12px">
        <div class="small-muted">Navigation</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button class="tab-btn" data-tab="dashboard">Dashboard</button>
          <button class="tab-btn" data-tab="journal">Journal</button>
          <button class="tab-btn" data-tab="mood">Mood</button>
        </div>
      </div>

      <div class="mini" id="userBox" style="display:none">
        <div id="userName" style="font-weight:800"></div>
        <div id="userEmail" class="small-muted"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="logoutBtn" class="btn">Logout</button>
          <button id="syncBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.6);padding:10px;border-radius:12px;cursor:pointer">Sync</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    Made with ♥ — Save to your account to sync across devices.
  </footer>

  <!-- AUTH Modal -->
  <div id="authModal" class="modal">
    <div class="modal-card">
      <h3 id="authTitle">Sign In</h3>
      <div style="margin-top:8px">
        <input id="authName" placeholder="Name (signup only)" style="width:100%;display:none" />
      </div>
      <div style="margin-top:8px"><input id="authEmail" placeholder="Email" style="width:100%" /></div>
      <div style="margin-top:8px"><input id="authPassword" type="password" placeholder="Password" style="width:100%" /></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="doAuth" class="btn">Sign In</button>
        <button id="switchAuth" style="background:transparent;border:none;cursor:pointer">Switch to Sign up</button>
      </div>
      <div id="authMsg" style="margin-top:8px;color:#b04242"></div>
    </div>
  </div>

<script>
/* ===========================
   Full frontend JS — Dreamy Soul Notes
   - Auth (JWT)
   - Local fallback
   - Habit / Todo / Goals UI
   - Particles background
   =========================== */

/* --- CONFIG: set this to your backend if needed --- */
const API_BASE = ""; // e.g. "http://localhost:5000"

/* helper shorteners */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

/* ---------- Particles (floating soft blobs) ---------- */
(function initParticles(){
  const canvas = document.getElementById('particle-canvas');
  const ctx = canvas.getContext('2d');
  let w = canvas.width = innerWidth;
  let h = canvas.height = innerHeight;
  const particles = [];
  const colors = ['rgba(249,200,209,0.14)','rgba(226,211,247,0.12)','rgba(215,243,236,0.10)','rgba(251,229,200,0.10)'];
  function rnd(min,max){ return Math.random()*(max-min)+min }
  for(let i=0;i<26;i++){
    particles.push({
      x: rnd(0,w),
      y: rnd(0,h),
      r: rnd(40,160),
      vx: rnd(-0.1,0.1),
      vy: rnd(-0.05,0.05),
      c: colors[i % colors.length],
      a: rnd(0.25,0.6)
    });
  }
  function draw(){
    ctx.clearRect(0,0,w,h);
    for(const p of particles){
      p.x += p.vx;
      p.y += p.vy;
      if (p.x < -200) p.x = w + 200;
      if (p.x > w + 200) p.x = -200;
      if (p.y < -200) p.y = h + 200;
      if (p.y > h + 200) p.y = -200;

      const g = ctx.createRadialGradient(p.x,p.y,p.r*0.1,p.x,p.y,p.r);
      g.addColorStop(0, p.c.replace('0.',''+(p.a*1)));
      g.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.beginPath();
      ctx.fillStyle = g;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  addEventListener('resize', ()=>{ w = canvas.width = innerWidth; h = canvas.height = innerHeight; });
  draw();
})();

/* ---------- Auth (JWT + local fallback) ---------- */
let JWT_TOKEN = localStorage.getItem('sn_token') || null;
let CURRENT_USER = JSON.parse(localStorage.getItem('sn_user') || 'null');

function setUserUI(user){
  if(user){
    qs('#userBox').style.display = 'block';
    qs('#userName').textContent = user.name || user.email.split('@')[0];
    qs('#userEmail').textContent = user.email;
    qs('#authButton').textContent = 'Account';
  } else {
    qs('#userBox').style.display = 'none';
    qs('#authButton').textContent = 'Log in';
  }
}
setUserUI(CURRENT_USER);

/* auth modal handlers */
let isSignup = false;
qs('#authButton').addEventListener('click', ()=> openAuthModal(false));
qs('#switchAuth').addEventListener('click', ()=> openAuthModal(!isSignup));
qs('#doAuth').addEventListener('click', doAuth);
qs('#authModal').addEventListener('click', (e)=>{ if(e.target===qs('#authModal')) closeAuthModal(); });

function openAuthModal(signup){
  isSignup = !!signup;
  qs('#authModal').style.display = 'flex';
  qs('#authTitle').textContent = signup ? 'Create Account' : 'Sign In';
  qs('#authName').style.display = signup ? 'block' : 'none';
  qs('#authMsg').textContent = '';
}
function closeAuthModal(){ qs('#authModal').style.display = 'none'; }

async function doAuth(){
  const email = qs('#authEmail').value.trim();
  const pw = qs('#authPassword').value;
  const name = qs('#authName').value.trim();
  if(!email || !pw){ qs('#authMsg').textContent = 'Provide email & password'; return; }
  try {
    const url = API_BASE + (isSignup ? '/api/register' : '/api/login');
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(isSignup?{email,pw,password:pw,name}:{email,password:pw}) });
    // note: some backends expect 'password' key — if your backend uses 'password' update body accordingly above
    // For compatibility, try both forms:
    if (res.status === 400 || res.status === 401) {
      // attempt alternate payload naming (if backend expects 'password')
      const alt = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(isSignup?{email,name,password:pw}:{email,password:pw}) });
      const altJson = await alt.json();
      if (!alt.ok) { qs('#authMsg').textContent = altJson.error || 'Auth failed'; return; }
      JWT_TOKEN = altJson.token; CURRENT_USER = altJson.user; localStorage.setItem('sn_token', JWT_TOKEN); localStorage.setItem('sn_user', JSON.stringify(CURRENT_USER));
      setUserUI(CURRENT_USER); closeAuthModal(); await loadAllUserData(); return;
    }
    const json = await res.json();
    if(!res.ok){ qs('#authMsg').textContent = json.error || 'Auth failed'; return; }
    JWT_TOKEN = json.token; CURRENT_USER = json.user;
    localStorage.setItem('sn_token', JWT_TOKEN); localStorage.setItem('sn_user', JSON.stringify(CURRENT_USER));
    setUserUI(CURRENT_USER); closeAuthModal();
    await loadAllUserData();
  } catch(err){
    console.error(err); qs('#authMsg').textContent = 'Network error';
  }
}

/* apiFetch helper */
async function apiFetch(path, opts = {}){
  const headers = opts.headers || {};
  if(!headers['Content-Type']) headers['Content-Type'] = 'application/json';
  if(JWT_TOKEN) headers['Authorization'] = 'Bearer ' + JWT_TOKEN;
  const res = await fetch(API_BASE + path, {...opts, headers});
  if(res.status === 401){
    JWT_TOKEN = null; CURRENT_USER = null; localStorage.removeItem('sn_token'); localStorage.removeItem('sn_user'); setUserUI(null);
    openAuthModal(false); throw new Error('Unauthorized');
  }
  return res;
}

/* ---------- Tabs ---------- */
qsa('.tab-btn').forEach(btn => btn.addEventListener('click', ()=> openTab(btn.dataset.tab)));
function openTab(tab){
  qsa('.tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
  qsa('main .panel').forEach(p=> p.style.display = p.id===tab ? 'block' : 'none');
}

/* ---------- Clock ---------- */
function updateClock(){
  const d = new Date();
  const h = d.getHours(); const m = d.getMinutes(); const pad = n=> n<10? '0'+n : n;
  qs('#timeNow').textContent = h+':'+pad(m); qs('#dashClock').textContent = h+':'+pad(m);
  qs('#dateNow').textContent = d.toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric'});
  qs('#dateNowSub').textContent = d.toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric'});
}
updateClock(); setInterval(updateClock,10000);

/* ---------- local storage helpers ---------- */
function saveLocal(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadLocal(k, fallback){ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }

/* ---------- Mood ---------- */
const moods = [{emoji:'😄',label:'Happy'},{emoji:'🙂',label:'Content'},{emoji:'😐',label:'Okay'},{emoji:'😔',label:'Sad'},{emoji:'😡',label:'Angry'},{emoji:'😴',label:'Tired'}];
const moodRow = qs('#moodRow');
moods.forEach((m, i)=>{
  const el = document.createElement('div'); el.className='mood-pill'; el.dataset.idx=i;
  el.innerHTML = `<div style="font-size:20px">${m.emoji}</div><div style="font-size:12px;margin-top:6px">${m.label}</div>`;
  el.addEventListener('click', ()=> selectMood(i));
  moodRow.appendChild(el);
});

function selectMood(idx){
  qsa('.mood-pill').forEach(p=> p.classList.toggle('selected', p.dataset.idx==idx));
  qs('#moodSaved').textContent=''; qs('#moodNote').value=''; qs('#moodNote').focus();
  qs('#saveMood').onclick = ()=> saveMood(idx);
}

async function saveMood(idx){
  const note = qs('#moodNote').value.trim();
  const entry = { when: new Date().toISOString(), mood: moods[idx], note };
  if (JWT_TOKEN){
    await apiFetch('/api/save_mood', { method:'POST', body: JSON.stringify({ mood: moods[idx], note }) });
    await loadAllUserData();
  } else {
    const arr = loadLocal('sn_mood_history', []); arr.unshift(entry); saveLocal('sn_mood_history', arr.slice(0,60));
    qs('#moodSaved').textContent = 'Saved (local)'; renderMoodHistory(); updateDashboardMood();
  }
}

function renderMoodHistory(){
  const arr = loadLocal('sn_mood_history', []); const wrap = qs('#moodHistory'); wrap.innerHTML='';
  arr.forEach(h=>{
    const d = new Date(h.when);
    const el = document.createElement('div'); el.style.padding='10px'; el.style.marginBottom='8px'; el.style.borderRadius='10px';
    el.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94))';
    el.style.border = '1px solid rgba(255,255,255,0.6)';
    el.innerHTML = `<div style="font-weight:700">${h.mood.emoji} ${h.mood.label}</div><div style="color:var(--muted);font-size:12px">${d.toLocaleString()}</div><div style="margin-top:6px">${h.note||''}</div>`;
    wrap.appendChild(el);
  });
}
renderMoodHistory();

/* ---------- Journal ---------- */
const journalKey = 'sn_journal_today';
qs('#journalText').value = loadLocal(journalKey, '');
qs('#saveJournal').addEventListener('click', async ()=>{
  const text = qs('#journalText').value;
  if (JWT_TOKEN){
    await apiFetch('/api/save_journal', { method:'POST', body: JSON.stringify({ journal: text }) });
    alert('Saved to server');
    await loadAllUserData();
  } else {
    saveLocal(journalKey, text); alert('Saved locally'); renderRecentEntry();
  }
});
qs('#clearJournal').addEventListener('click', ()=> { if(confirm('Clear journal?')){ qs('#journalText').value=''; saveLocal(journalKey,''); renderRecentEntry(); }});
qs('#attachImg').addEventListener('click', ()=> qs('#imgUpload').click());
qs('#imgUpload').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
  reader.onload = ()=> {
    const data = reader.result;
    if (JWT_TOKEN){
      apiFetch('/api/save_journal', { method:'POST', body: JSON.stringify({ journal: qs('#journalText').value, images: [data] }) })
        .then(()=> loadAllUserData()).catch(()=> alert('Upload failed'));
    } else {
      saveLocal('sn_journal_image', data); qs('#attachedPreview').innerHTML = `<img src="${data}" style="max-width:100%;border-radius:10px;"/>`;
    }
  }; reader.readAsDataURL(f);
});
const imgSaved = loadLocal('sn_journal_image', null); if(imgSaved) qs('#attachedPreview').innerHTML = `<img src="${imgSaved}" style="max-width:100%;border-radius:10px;"/>`;

let typingTimer; qs('#journalText').addEventListener('input', ()=>{ clearTimeout(typingTimer); typingTimer = setTimeout(()=>{ if(!JWT_TOKEN) saveLocal(journalKey, qs('#journalText').value); }, 1500); });

function renderRecentEntry(){ const v = loadLocal(journalKey, ''); qs('#recentEntry').textContent = v ? (v.length>200? v.slice(0,200)+'...' : v) : 'No entries yet — write something in Daily Journal.'; }
renderRecentEntry();

/* ---------- Gratitude ---------- */
const gratList = qs('#gratList');
function renderGrat(){ const arr = loadLocal('sn_grat',[]); gratList.innerHTML=''; arr.forEach((g,i)=>{ const li = document.createElement('li'); li.innerHTML = `<input type="checkbox" data-i="${i}" ${g.done? 'checked':''}> <div style="flex:1">${g.text}</div> <button data-del="${i}" style="border:none;background:transparent;cursor:pointer">✕</button>`; if(g.done) li.classList.add('done'); gratList.appendChild(li); }); }
qs('#addGrat').addEventListener('click', ()=>{ const v = qs('#gratInput').value.trim(); if(!v) return; const arr = loadLocal('sn_grat',[]); arr.unshift({text:v,done:false}); saveLocal('sn_grat',arr); qs('#gratInput').value=''; renderGrat(); })
gratList.addEventListener('click',(e)=>{ if(e.target.dataset.del!==undefined){ const i=+e.target.dataset.del; const arr=loadLocal('sn_grat',[]); arr.splice(i,1); saveLocal('sn_grat',arr); renderGrat(); } if(e.target.type==='checkbox'){ const i=+e.target.dataset.i; const arr=loadLocal('sn_grat',[]); arr[i].done = e.target.checked; saveLocal('sn_grat',arr); renderGrat(); } })
renderGrat();

/* ---------- Habits (cards) ---------- */
const habitGrid = qs('#habitGrid');
function makeHabitCard(h, idx){
  const div = document.createElement('div'); div.className = 'habit-card ' + (['p1','p2','p3','p4'][idx%4] || 'p1');
  div.innerHTML = `
    <div>
      <div class="habit-top">
        <div class="habit-title">${escapeHtml(h.name)}</div>
        <div class="habit-meta">${h.meta || ''}</div>
      </div>
      <div>
        <div class="habit-meta">Streak</div>
        <div class="habit-metric">${h.days || 0} days</div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <button class="tiny-btn" data-inc="${idx}">+ Day</button>
      <div style="font-size:12px;color:var(--muted)">Last: ${h.last || '-'}</div>
    </div>
  `;
  return div;
}
function renderHabitsFromLocal(){
  const arr = loadLocal('sn_habits', [{name:'Drink water',days:0,last:'-'},{name:'Morning walk',days:0,last:'-'}]);
  habitGrid.innerHTML = '';
  arr.forEach((h,i)=> habitGrid.appendChild(makeHabitCard(h,i)));
}
qs('#addHabit').addEventListener('click', ()=>{ const v = qs('#habitInput').value.trim(); if(!v) return; const arr = loadLocal('sn_habits',[]); arr.unshift({name:v,days:0,last:'-'}); saveLocal('sn_habits',arr); qs('#habitInput').value=''; renderHabitsFromLocal(); });
habitGrid.addEventListener('click',(e)=>{ if(e.target.dataset.inc!==undefined){ const i=+e.target.dataset.inc; const arr=loadLocal('sn_habits',[]); arr[i].days=(arr[i].days||0)+1; arr[i].last=(new Date()).toLocaleDateString(); saveLocal('sn_habits',arr); renderHabitsFromLocal(); } });
renderHabitsFromLocal();

/* ---------- To-Do Task Manager ---------- */
function renderTasksFromLocal(){
  const arr = loadLocal('sn_todo',[]);
  qs('#taskBody').innerHTML = '';
  arr.forEach((t,idx)=>{
    const tr = document.createElement('tr'); tr.className='task-row';
    tr.innerHTML = `
      <td style="padding:12px">${idx+1}</td>
      <td><input data-text="${idx}" value="${escapeHtml(t.text||'')}" style="width:100%;border:none;background:transparent" /></td>
      <td>
        <select data-prio="${idx}" class="priority-select">
          <option ${t.priority==='Low'?'selected':''}>Low</option>
          <option ${t.priority==='Medium'?'selected':''}>Medium</option>
          <option ${t.priority==='High'?'selected':''}>High</option>
        </select>
      </td>
      <td><input type="date" data-start="${idx}" value="${t.start||''}" /></td>
      <td><input type="date" data-due="${idx}" value="${t.due||''}" /></td>
      <td><input data-notes="${idx}" value="${escapeHtml(t.notes||'')}" style="width:100%;border:none;background:transparent" /></td>
      <td><input type="number" min="0" max="100" data-percent="${idx}" value="${t.percent||0}" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.6)" />%</td>
      <td><div class="progress-bar"><div class="progress-fill" style="width:${t.percent||0}%"></div></div></td>
      <td><button data-del="${idx}" style="border:none;background:transparent;cursor:pointer">✕</button></td>
    `;
    qs('#taskBody').appendChild(tr);
  });

  qsa('input[data-text]').forEach(i=>i.addEventListener('input', taskFieldChanged));
  qsa('input[data-notes]').forEach(i=>i.addEventListener('input', taskFieldChanged));
  qsa('select[data-prio]').forEach(s=>s.addEventListener('change', taskFieldChanged));
  qsa('input[data-start]').forEach(i=>i.addEventListener('change', taskFieldChanged));
  qsa('input[data-due]').forEach(i=>i.addEventListener('change', taskFieldChanged));
  qsa('input[data-percent]').forEach(i=>i.addEventListener('input', (e)=>{ taskFieldChanged(e); updateProgressVisual(); }));
  qsa('button[data-del]').forEach(b=>b.addEventListener('click',(e)=>{ const idx=+e.target.dataset.del; const arr=loadLocal('sn_todo',[]); arr.splice(idx,1); saveLocal('sn_todo',arr); renderTasksFromLocal(); updateDashboardTask(); }));
  updateProgressVisual();
}
function taskFieldChanged(e){
  const idx = +e.target.dataset.text ?? +e.target.dataset.prio ?? +e.target.dataset.start ?? +e.target.dataset.due ?? +e.target.dataset.notes ?? +e.target.dataset.percent;
  const arr = loadLocal('sn_todo',[]);
  if(!arr[idx]) return;
  const el = e.target;
  if(el.dataset.text!==undefined) arr[idx].text = el.value;
  if(el.dataset.notes!==undefined) arr[idx].notes = el.value;
  if(el.dataset.prio!==undefined) arr[idx].priority = el.value;
  if(el.dataset.start!==undefined) arr[idx].start = el.value;
  if(el.dataset.due!==undefined) arr[idx].due = el.value;
  if(el.dataset.percent!==undefined) arr[idx].percent = Math.max(0,Math.min(100,Number(el.value||0)));
  saveLocal('sn_todo',arr); updateDashboardTask(); renderTasksFromLocal();
}
function updateProgressVisual(){ qsa('.progress-fill').forEach(el=>{}); }
qs('#addTodo').addEventListener('click', ()=>{ const text = qs('#todoInput').value.trim(); if(!text) return; const prio = qs('#todoPriority').value; const arr = loadLocal('sn_todo',[]); arr.unshift({text,priority:prio,start:'',due:'',notes:'',percent:0}); saveLocal('sn_todo',arr); qs('#todoInput').value=''; renderTasksFromLocal(); updateDashboardTask(); });
function updateTaskCounts(){ const arr = loadLocal('sn_todo',[]); qs('#totalTasks').textContent = arr.length; qs('#inProgressCount').textContent = arr.filter(t=> (t.percent||0) < 100).length; }

/* ---------- Goals ---------- */
function renderGoalsLocal(){
  const arr = loadLocal('sn_goals',[]);
  const wrap = qs('#goalsWrap'); wrap.innerHTML='';
  arr.forEach((g,idx)=>{
    const card = document.createElement('div'); card.className='goal-card';
    const pct = g.percent || 0;
    card.innerHTML = `<div class="goal-circle">${pct}%</div><div style="flex:1"><div style="font-weight:800">${escapeHtml(g.text)}</div><div class="small-muted">${g.target||''}</div></div><div style="display:flex;flex-direction:column;gap:8px"><button data-complete="${idx}" class="btn">+ Progress</button><button data-delg="${idx}" style="background:transparent;border:1px solid rgba(255,255,255,0.6);padding:8px;border-radius:10px;cursor:pointer">Delete</button></div>`;
    wrap.appendChild(card);
  });
  qsa('button[data-complete]').forEach(b=>b.addEventListener('click',(e)=>{ const idx=+e.target.dataset.complete; const arr = loadLocal('sn_goals',[]); arr[idx].percent = Math.min(100,(arr[idx].percent||0)+10); saveLocal('sn_goals',arr); renderGoalsLocal(); }));
  qsa('button[data-delg]').forEach(b=>b.addEventListener('click',(e)=>{ const idx=+e.target.dataset.delg; const arr = loadLocal('sn_goals',[]); arr.splice(idx,1); saveLocal('sn_goals',arr); renderGoalsLocal(); }));
}
qs('#addGoal').addEventListener('click', ()=>{ const t = qs('#goalInput').value.trim(); const d = qs('#goalTargetDate').value; if(!t) return; const arr = loadLocal('sn_goals',[]); arr.unshift({text:t,target:d,percent:0}); saveLocal('sn_goals',arr); qs('#goalInput').value=''; qs('#goalTargetDate').value=''; renderGoalsLocal(); });

/* ---------- Dashboard helpers ---------- */
function updateDashboardMood(){ const h = loadLocal('sn_mood_history',[])[0]; const label = h ? (h.mood.emoji+' '+h.mood.label) : '—'; qs('#dashMood').textContent = label; qs('#sideMood').textContent = label; }
function updateDashboardTask(){ const t = loadLocal('sn_todo',[]).find(x=> (x.percent||0) < 100); qs('#dashTask').textContent = t ? t.text : '—'; }
function updateCountsUI(){ updateTaskCounts(); }
updateDashboardMood(); updateDashboardTask(); updateCountsUI();

/* ---------- Sync with server ---------- */
async function loadAllUserData(){
  if(!JWT_TOKEN){
    renderHabitsFromLocal();
    renderTasksFromLocal();
    renderGoalsLocal();
    renderGrat();
    renderMoodHistory();
    renderRecentEntry();
    updateCountsUI();
    return;
  }
  try {
    const res = await apiFetch('/api/fetch_data',{ method:'GET' });
    const json = await res.json(); const data = json.data || {};
    if (data.habits) saveLocal('sn_habits', data.habits);
    if (data.todos) saveLocal('sn_todo', data.todos);
    if (data.goals) saveLocal('sn_goals', data.goals);
    if (data.mood_history) saveLocal('sn_mood_history', data.mood_history);
    if (data.journal !== undefined) saveLocal(journalKey, data.journal);
    if (data.journal_images && data.journal_images[0]) saveLocal('sn_journal_image', data.journal_images[0]);

    renderHabitsFromLocal();
    renderTasksFromLocal();
    renderGoalsLocal();
    renderGrat();
    renderMoodHistory();
    renderRecentEntry();
    updateCountsUI();
    setUserUI(CURRENT_USER || data.user || { email: data.email });
  } catch(err){
    console.error('Failed to load server data', err);
  }
}

async function saveHabitsToServer(){
  if(!JWT_TOKEN){ openAuthModal(false); return; }
  const arr = loadLocal('sn_habits',[]); await apiFetch('/api/save_habits',{ method:'POST', body: JSON.stringify({ habits: arr }) }); alert('Habits saved');
}
async function saveTodosToServer(){
  if(!JWT_TOKEN){ openAuthModal(false); return; }
  const arr = loadLocal('sn_todo',[]); await apiFetch('/api/save_todos',{ method:'POST', body: JSON.stringify({ todos: arr }) }); alert('Tasks saved');
}
async function saveGoalsToServer(){
  if(!JWT_TOKEN){ openAuthModal(false); return; }
  const arr = loadLocal('sn_goals',[]); await apiFetch('/api/save_goals',{ method:'POST', body: JSON.stringify({ goals: arr }) }); alert('Goals saved');
}

qs('#syncBtn').addEventListener('click', async ()=>{ if(!JWT_TOKEN){ openAuthModal(false); return; } await saveHabitsToServer(); await saveTodosToServer(); await saveGoalsToServer(); alert('Synced with server'); });

qs('#logoutBtn').addEventListener('click', ()=>{ JWT_TOKEN = null; CURRENT_USER = null; localStorage.removeItem('sn_token'); localStorage.removeItem('sn_user'); setUserUI(null); alert('Logged out (local data remains)'); });

/* ---------- Utilities ---------- */
function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Initial load ---------- */
(async ()=>{
  // load local UI quickly
  renderHabitsFromLocal();
  renderTasksFromLocal();
  renderGoalsLocal();
  renderGrat();
  renderMoodHistory();
  renderRecentEntry();
  updateCountsUI();

  if (JWT_TOKEN){
    try { await loadAllUserData(); } catch(err){ console.warn('Server load failed', err); }
  }
})();

/* ---------- small helpers ---------- */
qs('#openJournalFromMini').addEventListener('click', ()=> openTab('journal'));
qs('#newEntry')?.addEventListener('click', ()=>{ openTab('journal'); qs('#journalText').focus(); });
qs('#globalSearch').addEventListener('input', (e)=> {
  const q = e.target.value.toLowerCase(); if(!q) return;
  const j = loadLocal(journalKey,'').toLowerCase();
  const todos = loadLocal('sn_todo',[]);
  const goals = loadLocal('sn_goals',[]);
  let found = 'No matches';
  if (j.includes(q)) found = 'Found in Journal';
  else if (todos.some(t=> (t.text||'').toLowerCase().includes(q))) found = 'Found in Tasks';
  else if (goals.some(g=> (g.text||'').toLowerCase().includes(q))) found = 'Found in Goals';
  const toast = document.createElement('div'); toast.textContent = found; toast.style.position='fixed'; toast.style.right='20px'; toast.style.top='90px'; toast.style.background='linear-gradient(90deg,#fff,#fff)'; toast.style.padding='10px 14px'; toast.style.borderRadius='10px'; toast.style.boxShadow='var(--shadow-soft)'; document.body.appendChild(toast); setTimeout(()=> toast.remove(),1600);
});
</script>
</body>
</html>
