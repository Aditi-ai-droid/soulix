<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soulix — Avatar Studio (Combo)</title>

<!-- Lottie -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<!-- Three.js + GLTFLoader for optional GLB preview -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#fff6fb; --bg2:#f4fbff; --muted:#7d6a78;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Montserrat,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#3d2b3b}
  .wrap{max-width:1200px;margin:22px auto;padding:18px;display:grid;grid-template-columns:560px 1fr;gap:18px}
  .card{background:rgba(255,255,255,0.95);border-radius:14px;padding:14px;box-shadow:0 20px 60px rgba(100,50,100,0.06)}
  .left{display:flex;flex-direction:column;align-items:center;gap:12px}
  .right{display:flex;flex-direction:column;gap:12px}
  .h{font-weight:700;font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#f9c8d1,#e2d3f7);border:none;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  #threePreview{width:100%;height:360px;border-radius:10px;background:linear-gradient(180deg,#fbfbff,#fff);display:grid;place-items:center}
  input[type="file"]{display:none}
  .control { display:flex; gap:8px; flex-wrap:wrap }
  footer{margin-top:12px;text-align:center;color:var(--muted)}
  @media (max-width:980px){ .wrap{grid-template-columns:1fr; padding:12px} #threePreview{height:300px} }
</style>
</head>
<body>

<div class="wrap">
  <!-- LEFT: Lottie animated character + quick mood controls -->
  <div class="card left">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="h">Soulix — Animated Assistant</div>
        <div class="small muted">Instant animated avatar (Lottie) — switch moods</div>
      </div>
      <div style="text-align:right">
        <button id="helpBtn" class="btn">?</button>
      </div>
    </div>

    <!-- Lottie preview -->
    <div id="lottieWrap" style="width:320px;height:320px;display:grid;place-items:center;margin-top:6px">
      <lottie-player id="lottiePlayer" src="https://assets3.lottiefiles.com/packages/lf20_47pyywcg.json" background="transparent" speed="1" style="width:300px;height:300px;" loop autoplay></lottie-player>
    </div>

    <div style="width:100%;display:flex;gap:8px;justify-content:center">
      <button class="btn" onclick="setMood('idle')">Idle</button>
      <button class="btn" onclick="setMood('happy')">Happy</button>
      <button class="btn" onclick="setMood('thinking')">Thinking</button>
      <button class="btn" onclick="setMood('wave')">Wave</button>
    </div>

    <div style="width:100%;margin-top:10px">
      <div class="small muted">Tip: This animated assistant gives instant feedback while you create your 3D avatar.</div>
    </div>
  </div>

  <!-- RIGHT: 3D avatar flow (RPM + upload + preview + save) -->
  <div class="card right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="h">3D Avatar (Ready Player Me or Upload)</div>
        <div class="muted">Create a Snap-style 3D avatar or upload your own .glb — then save to your account.</div>
      </div>
      <div class="row">
        <button id="rpmBtn" class="btn primary">Create (Ready Player Me)</button>
      </div>
    </div>

    <!-- Model preview -->
    <div id="threePreview" style="margin-top:12px">No 3D avatar loaded yet</div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <label class="btn">Upload .glb<input id="glbInput" type="file" accept=".glb,.gltf" /></label>
      <button id="loadUrl" class="btn">Load GLB URL</button>
      <input id="urlInput" placeholder="Paste GLB URL (RPM hosted or CDN)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <div style="flex:1">
        <div class="small muted">Hair color</div>
        <input id="hairColor" type="color" value="#3b2a20" style="width:100%;height:40px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
      </div>
      <div style="flex:1">
        <div class="small muted">Outfit color</div>
        <input id="outfitColor" type="color" value="#8f5aa0" style="width:100%;height:40px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small muted">Accessories</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" data-acc="none">None</button>
        <button class="btn" data-acc="glasses">Glasses</button>
        <button class="btn" data-acc="hat">Hat</button>
        <button class="btn" data-acc="scarf">Scarf</button>
      </div>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px">
      <button id="saveBtn" class="btn primary" style="flex:1">Save Avatar</button>
      <button id="exportPng" class="btn">Download PNG</button>
    </div>

    <div style="margin-top:10px" class="small muted">Saved: <span id="savedInfo">none</span></div>
  </div>
</div>

<footer>
  <div class="small muted">Soulix — Avatar combo: Lottie + Ready Player Me + Upload. Works with Flask backend.</div>
</footer>

<script>
/* ============================
  Combo Avatar Page JS
  - Lottie mood switching (instant)
  - Ready Player Me flow (popup) → receives avatar GLB URL via postMessage
  - GLB upload/load preview using Three.js
  - color tint controls (best-effort on material names)
  - save to server (POST /api/save_avatar)
  ============================ */

/* ---------- CONFIG (change to your server) ---------- */
const API_BASE = ""; // e.g. "http://127.0.0.1:5000"
const RPM_POPUP_URL = "https://creator.readyplayer.me/avatar?frameApi"; // open this to create RPM avatar

/* ---------- Lottie moods ---------- */
const lottiePlayer = document.getElementById('lottiePlayer');
function setMood(m){
  // choose Lottie animations (URLs) - these are public Lottie assets; swap if you prefer
  const map = {
    idle: "https://assets3.lottiefiles.com/packages/lf20_47pyywcg.json",
    happy: "https://assets9.lottiefiles.com/packages/lf20_jbrw3hcz.json",
    thinking: "https://assets2.lottiefiles.com/packages/lf20_kqj5gwig.json",
    wave: "https://assets2.lottiefiles.com/packages/lf20_d0lzskqk.json"
  };
  const url = map[m] || map.idle;
  lottiePlayer.load(url);
}
setMood('idle');

/* ---------- Ready Player Me popup flow ---------- */
let rpmWindow = null;
document.getElementById('rpmBtn').addEventListener('click', ()=>{
  // open RPM create page in new window
  rpmWindow = window.open(RPM_POPUP_URL, "rpm", "width=900,height=700");
  alert("Ready Player Me will open in a new window. Create avatar and click Export → Download GLB or copy hosted URL. After creation, paste the GLB URL into the input or upload the downloaded .glb.");
});

// Optionally, you can listen for messages if RPM iframe sends (advanced integration with RPM SDK).
window.addEventListener('message', (ev) => {
  // Ready Player Me sends messages if using Frame API; however cross-origin and RPM SDK needed for direct event
  // This block is here for forward-compatibility.
  try {
    const d = ev.data || {};
    // Example: { source: 'readyplayerme', eventName: 'v1.avatar.exported', data: { url: 'https://...' } }
    if (d.source === 'readyplayerme' && d.eventName === 'v1.avatar.exported') {
      const url = d.data.url;
      console.log('RPM exported url:', url);
      document.getElementById('urlInput').value = url;
      loadGlbFromUrl(url);
      alert('Ready Player Me avatar URL received and loaded.');
    }
  } catch(e){}
});

/* ---------- Three.js GLB preview ---------- */
let scene, camera, renderer, controls, avatarRoot = null, skinnedMesh = null;
function initThreePreview(){
  const container = document.getElementById('threePreview');
  // clear existing canvas
  container.innerHTML = '';
  const w = container.clientWidth, h = container.clientHeight;
  scene = new THREE.Scene(); scene.background = new THREE.Color(0xf7fbfc);
  camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 2000);
  camera.position.set(0,1.6,3);
  renderer = new THREE.WebGLRenderer({ antialias:true, preserveDrawingBuffer:true });
  renderer.setSize(w,h); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  container.appendChild(renderer.domElement);
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.target.set(0,1.2,0);
  scene.add(new THREE.AmbientLight(0xffffff,0.9));
  const dir = new THREE.DirectionalLight(0xffffff,0.6); dir.position.set(5,10,5); scene.add(dir);
  animateThree();
}
function animateThree(){
  requestAnimationFrame(animateThree);
  controls.update();
  if (avatarRoot && !!window.autoRotateGlb) avatarRoot.rotation.y += 0.005;
  renderer.render(scene, camera);
}
initThreePreview();

/* GLTF loader */
const loader = new THREE.GLTFLoader();
function loadGlbFromUrl(url){
  if (!url) return alert('Paste a valid GLB URL');
  document.getElementById('threePreview').textContent = 'Loading...';
  loader.load(url, (gltf)=>{
    addAvatarToScene(gltf.scene);
    document.getElementById('threePreview').textContent = '';
    fitCameraToObject(gltf.scene);
  }, (xhr)=>{}, (err)=>{ console.error(err); alert('Failed to load GLB: '+err.message); document.getElementById('threePreview').textContent = 'Load failed'; });
}
function addAvatarToScene(obj){
  if (avatarRoot) { scene.remove(avatarRoot); avatarRoot.traverse(o=>{ if (o.isMesh) { o.geometry?.dispose(); if (o.material) { if (Array.isArray(o.material)) o.material.forEach(m=>m.dispose()); else o.material.dispose(); } } }); avatarRoot = null;}
  avatarRoot = obj;
  avatarRoot.position.set(0,0,0);
  // simple scale heuristic
  const box = new THREE.Box3().setFromObject(avatarRoot); const size = box.getSize(new THREE.Vector3()).length();
  const scale = 1.6 / size; if (isFinite(scale)) avatarRoot.scale.setScalar(scale);
  scene.add(avatarRoot);
  // find first skinned mesh (if any) for tinting
  avatarRoot.traverse(c => { if (c.isSkinnedMesh && !skinnedMesh) skinnedMesh = c; });
  document.getElementById('savedInfo').textContent = 'Loaded (preview)';
}
function fitCameraToObject(object){
  const box = new THREE.Box3().setFromObject(object);
  const center = box.getCenter(new THREE.Vector3());
  const size = box.getSize(new THREE.Vector3()).length();
  camera.position.copy(center);
  camera.position.x += size * 0.8;
  camera.position.y += size * 0.5;
  camera.position.z += size * 1.2;
  controls.target.copy(center);
}

/* file input handler */
document.getElementById('glbInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const arrayBuffer = ev.target.result;
    loader.parse(arrayBuffer, '', (gltf) => { addAvatarToScene(gltf.scene); document.getElementById('savedInfo').textContent = f.name; fitCameraToObject(gltf.scene); }, (err)=>{ alert('Parse error: '+err); console.error(err); });
  };
  reader.readAsArrayBuffer(f);
});

/* load URL button */
document.getElementById('loadUrl').addEventListener('click', ()=> {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return alert('Paste GLB url first');
  loadGlbFromUrl(url);
});

/* color controls (best-effort) */
document.getElementById('hairColor').addEventListener('input', (e)=> applyColorToMaterial(e.target.value, ['hair','head_hair','Hair']));
document.getElementById('outfitColor').addEventListener('input', (e)=> applyColorToMaterial(e.target.value, ['clothes','shirt','body','outfit','top']));

function applyColorToMaterial(hex, nameHints){
  if (!skinnedMesh) return;
  const mats = Array.isArray(skinnedMesh.material) ? skinnedMesh.material : [skinnedMesh.material];
  mats.forEach(m => {
    const n = (m.name || '').toLowerCase();
    if (nameHints.some(h=> n.includes(h))) {
      try { m.color.set(hex); m.needsUpdate = true; } catch(e){ console.warn(e); }
    }
  });
}

/* accessories buttons */
document.querySelectorAll('[data-acc]').forEach(btn=> btn.addEventListener('click', (e)=>{
  const acc = e.target.dataset.acc;
  // simple accessory injection near head (approximate)
  if (!avatarRoot) return alert('Load avatar first');
  // remove old accessory
  const prev = avatarRoot.getObjectByName('soulix_acc');
  if (prev) avatarRoot.remove(prev);
  if (acc === 'none') return;
  const g = new THREE.Group(); g.name = 'soulix_acc';
  if (acc === 'glasses'){
    const mat = new THREE.MeshStandardMaterial({ color: 0x222222 });
    const left = new THREE.Mesh(new THREE.BoxGeometry(0.46,0.2,0.06), mat); left.position.set(-0.18,1.05,0.65);
    const right = new THREE.Mesh(new THREE.BoxGeometry(0.46,0.2,0.06), mat); right.position.set(0.18,1.05,0.65);
    const bridge = new THREE.Mesh(new THREE.BoxGeometry(0.12,0.06,0.04), mat); bridge.position.set(0,1.05,0.65);
    g.add(left,right,bridge);
  } else if (acc === 'hat'){
    const mat = new THREE.MeshStandardMaterial({ color: 0x1f1f1f });
    const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.9,0.9,0.06,32), mat); brim.position.set(0,1.32,0);
    const crown = new THREE.Mesh(new THREE.CylinderGeometry(0.48,0.48,0.28,28), mat); crown.position.set(0,1.52,0);
    g.add(brim,crown);
  } else if (acc === 'scarf'){
    const mat = new THREE.MeshStandardMaterial({ color: 0xac5ba0 });
    const tor = new THREE.Mesh(new THREE.TorusGeometry(0.55,0.12,16,40), mat); tor.rotation.x = Math.PI/2; tor.position.set(0,0.25,0);
    g.add(tor);
  }
  avatarRoot.add(g);
}));

/* export PNG */
document.getElementById('exportPng').addEventListener('click', ()=>{
  if (!renderer) return alert('Preview not initialized');
  try {
    const data = renderer.domElement.toDataURL('image/png');
    const a = document.createElement('a'); a.href = data; a.download = 'soulix-avatar.png'; a.click();
  } catch(e){ alert('Export failed: '+e.message); }
});

/* save to server: collects config, snapshot and avatar url (if any) */
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const config = {
    mood: (lottiePlayer && lottiePlayer.getAttribute('src')) || 'lottie',
    hairColor: document.getElementById('hairColor').value,
    outfitColor: document.getElementById('outfitColor').value,
    glbUrl: document.getElementById('urlInput').value || null,
    savedAt: new Date().toISOString()
  };
  // snapshot
  let imageData = null;
  try { imageData = renderer.domElement.toDataURL('image/png'); } catch(e){ console.warn('snapshot failed', e); }

  // If API_BASE not set -> save local
  if (!API_BASE){
    localStorage.setItem('soulix_avatar_combo', JSON.stringify({ config, imageData }));
    document.getElementById('savedInfo').textContent = 'saved: local';
    alert('Saved locally (no server configured).');
    return;
  }

  try {
    const res = await fetch(API_BASE + '/api/save_avatar', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ user: 'demo@example.com', config, image: imageData })
    });
    if (!res.ok) throw new Error('Server error');
    const data = await res.json();
    document.getElementById('savedInfo').textContent = data.id || 'saved';
    alert('Saved to server');
  } catch(err){ console.error(err); alert('Save error: ' + err.message); }
});

/* small helpers */
window.autoRotateGlb = true;
document.getElementById('helpBtn').addEventListener('click', ()=> alert('Flow:\n1) Create avatar with Ready Player Me or upload .glb\n2) Preview & tint colors\n3) Save (to local or server)\n\nTip: For best tint control, use models with labeled materials (hair/clothes).'));

</script>
</body>
</html>
